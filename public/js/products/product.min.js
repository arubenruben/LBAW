const token=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),btnText=document.getElementById("moreTextButton"),dots=document.getElementById("dots"),moreText=document.getElementById("more"),seeMoreButtons=document.getElementById("see-more-buttons"),readmoreText=document.querySelector("#text-readmore");let allAddToCartButtons=document.querySelectorAll(".button-offer");const radioButtons=document.getElementById("radio-buttons");function collapseDescription(){"none"===dots.style.display?(dots.style.display="inline",btnText.innerHTML="Read more",moreText.style.display="none"):(dots.style.display="none",btnText.innerHTML="Read less",moreText.style.display="inline")}readmoreText.textContent.length<200?btnText.style.display="none":(btnText.addEventListener("click",collapseDescription),btnText.style.display="block");const htmlToInsertWithoutOffers='<div class="col-sm-12 text-center align-middle"> <p class = "mt-5" >No offers available for this product</p> </div >',cartItemCounter=document.querySelector("#shopping_cart_item_counter"),counterNumberOffers=document.querySelector("#counter-number-offers"),htmlToInsertPlace=document.querySelector("#offers-content"),sendPut=e=>{const t={headers:{"Content-Type":"application/json",Accept:"application/json, text-plain, */*","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":token},method:"put",credentials:"same-origin",body:JSON.stringify(e)};let o=document.querySelectorAll(".button-offer"),r=null;return o.forEach(t=>{t.getAttribute("data-offer")===e.offer_id&&(r=t)}),r.disabled=!0,fetch("/cart/",t).then(function(t){if(t.ok){cartItemCounter.innerHTML=parseInt(cartItemCounter.innerHTML)+1;let t=document.querySelector("#offer-"+e.offer_id+"-stock");if(t.innerHTML-=1,r.disabled=!1,"0"==t.innerHTML){document.querySelector("#entry-offer-"+e.offer_id).remove(),counterNumberOffers.innerHTML-=1,"0"!==counterNumberOffers.innerHTML||radioButtons.classList.contains("d-none")||(radioButtons.className+=" d-none",htmlToInsertPlace.innerHTML=htmlToInsertWithoutOffers)}}t.json()}).catch(e=>console.error("Error:"+e))},addEventListenerAddToCardButton=()=>{(allAddToCartButtons=document.querySelectorAll(".button-offer")).forEach(e=>{e.addEventListener("click",()=>{let t={offer_id:e.getAttribute("data-offer")};sendPut(t)})})};addEventListenerAddToCardButton();const sendGet=e=>{const t={headers:{"Content-Type":"application/json",Accept:"application/json, text-plain, */*","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":token},method:"get",credentials:"same-origin"};return fetch("/api/product/sort?"+encodeForAjax(e),t).then(e=>e.json()).catch(e=>console.error("Error: "+e))};let radioBestRating=document.querySelector("#radio_best_rating"),radioBestPrice=document.querySelector("#radio_best_price"),seeMoreOffers=document.querySelector("#see_more_offers"),closeMoreOffers=document.querySelector("#close_more_offers"),loadingMoreOffers=document.querySelector("#loading_offers");null!=seeMoreOffers&&null!=closeMoreOffers&&(seeMoreOffers.addEventListener("click",collapseOffers),closeMoreOffers.addEventListener("click",collapseOffers));const templateEntryOffer=(e,t,o,r,n,s,l,a,d,c)=>{let f=`<tr id = "entry-offer-${o}" class="offer`;return!0===c&&(f+=' offer_outside" style="display: none;'),f+=`">\n    <td scope="row" class="border-0 align-middle">\n        <div class="p-2 m-0">\n            <h4><a data-toggle="modal" data-target="#user-{{$offer->seller->id}}" href="#"\n                    class="seller" style="color:black">${e}</a></h4>\n            <span class="font-weight-bold cl-success">\n                <i class="fas fa-thumbs-up"></i> ${t}\n            </span>\n            <span>\n                | <i class="fas fa-shopping-cart"></i> ${r} |\n            </span>\n            <span >\n                Stock:<span id="offer-${o}-stock">${l}</span>\n            </span>\n        </div>\n    </td>`,f+=n!==s?'<td class="text-center align-middle"><del><strong> $'+`${(Math.round(100*n)/100).toFixed(2)}</strong></del><strong\n            class="cl-green pl-2">`+"$"+`${(Math.round(100*s)/100).toFixed(2)} </strong></td>`:' <td class="text-center align-middle"><strong>$'+`${(Math.round(100*n)/100).toFixed(2)}</strong></td>`,f+='<td class="text-center align-middle">\n        <div class="btn-group-justified">',f+="none"!==a?` <button data-offer="${o}"\n                class="btn btn-orange button-offer"\n                ${d?"disabled":""}><i class="fas fa-cart-plus"></i></button>`:` <button data-offer="${o}"\n                   class="btn btn-orange button-offer"><i class="fas fa-cart-plus"></i></button>`,f+=" </div> </td> </tr>"},received=e=>{let t,o=document.querySelector("#offers_body"),r="";for(let o=0;o<e.offers.length;o++)t=o>=10,r+=templateEntryOffer(e.offers[o].username,e.offers[o].rating,e.offers[o].offer_id,e.offers[o].num_sells,e.offers[o].price,e.offers[o].discount_price,e.offers[o].stock,e.current_user,e.banned,t);o.innerHTML=r,addEventListenerAddToCardButton()},receivedAll=e=>{let t,o=document.querySelector("#offers_body");for(let r=0;r<e.offers.length;r++)t=!0,o.innerHTML+=templateEntryOffer(e.offers[r].username,e.offers[r].rating,e.offers[r].offer_id,e.offers[r].num_sells,e.offers[r].price,e.offers[r].discount_price,e.offers[r].stock,e.current_user,e.banned,!0);addEventListenerAddToCardButton()};let changedSortBy=!0;async function collapseOffers(){let e=document.querySelectorAll(".offer_outside");if("none"===seeMoreOffers.style.display||seeMoreOffers.classList.contains("d-none")){seeMoreOffers.style.display="block",closeMoreOffers.style.display="none";for(let t=0;t<e.length;t++)e[t].style.display="none"}else if("none"===closeMoreOffers.style.display||closeMoreOffers.classList.contains("d-none")){changedSortBy&&(seeMoreOffers.style.display="none",loadingMoreOffers.style.display="block",await sendRequestForAllOffers(),changedSortBy=!1),loadingMoreOffers.style.display="none",e=document.querySelectorAll(".offer_outside"),closeMoreOffers.style.display="block",seeMoreOffers.style.display="none";for(let t=0;t<e.length;t++)e[t].style.display="table-row"}}const sendRequest=()=>{changedSortBy=!0;let e=assembleData(!1);sendGet(e).then(e=>received(e)).catch(e=>console.error("Error: "+e))},sendRequestForAllOffers=async()=>{let e=assembleData(!0);await sendGet(e).then(e=>receivedAll(e)).catch(e=>console.error("Error: "+e))};function assembleData(e){let t=document.querySelector("#product_name_platform"),o={};return o.game_name=t.getAttribute("data_product_name"),o.game_platform=t.getAttribute("data_product_platform"),radioBestRating.checked?o.sort_by="rating":o.sort_by="price",o.all_offers=e,o}function encodeForAjax(e){return null==e?null:Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")}radioBestPrice.addEventListener("click",sendRequest),radioBestRating.addEventListener("click",sendRequest);